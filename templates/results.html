{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <!-- Navbar -->
  <nav class="mb-4">
    <ul class="nav nav-pills">
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('profile', adm_no=student['Admission Number']) }}">👤 Profile</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('gallery', adm_no=student['Admission Number']) }}">🖼️ Gallery</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="{{ url_for('results', adm_no=student['Admission Number']) }}">📊 Results</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('letter', adm_no=student['Admission Number']) }}">✉️ Letters</a>
      </li>
    </ul>
  </nav>

  <!-- Student Info -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <h4 class="text-maroon">{{ student["Full Name"] }}</h4>
      <p><strong>Admission Number:</strong> {{ student["Admission Number"] }}</p>
    </div>
  </div>

  <!-- Academic Scores -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <h5 class="mb-3">📊 Academic Results</h5>
      {% if results %}
        <ul class="list-group mb-3">
          {% for r in results %}
            <li class="list-group-item">{{ r.subject }}: {{ r.score }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No academic results uploaded yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Result Images Upload -->
  <div class="card shadow mb-4">
    <div class="card-body">
      <h5 class="mb-3">📷 Upload Result Images</h5>
      <form method="POST" action="{{ url_for('upload_result_file', adm_no=student['Admission Number']) }}" enctype="multipart/form-data" class="mb-4">
        <input type="file" name="result_file" class="form-control mb-2" accept="image/*" multiple required>
        <input type="text" name="note" class="form-control mb-2" placeholder="Optional note about the result">
        <button type="submit" class="btn btn-maroon">Upload</button>
      </form>

      <!-- Display Uploaded Result Images -->
      {% if result_images %}
        <div class="row">
          {% for file in result_images %}
            <div class="col-md-4 col-sm-6 mb-4 text-center">
              <img src="{{ file.url }}" alt="Result Image" 
                   class="img-fluid rounded shadow-sm result-thumb"
                   data-index="{{ loop.index0 }}"
                   style="cursor:pointer;">
              {% if file.note %}
                <p class="mt-2 small">{{ file.note }}</p>
              {% endif %}
              <button class="btn btn-sm btn-danger mt-1" onclick="deleteFile('{{ student['Admission Number'] }}', '{{ file.public_id }}', 'result', this)">🗑️ Delete</button>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">No result images uploaded yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal for Result Slideshow -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-0">
        <h5 class="modal-title">📊 Result Preview</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalResultImg" src="" class="img-fluid rounded shadow">
        <p id="modalResultNote" class="mt-2"></p>
      </div>
      <div class="modal-footer justify-content-between border-0">
        <button type="button" class="btn btn-light" id="prevResult">⬅️ Prev</button>
        <button type="button" class="btn btn-light" id="nextResult">Next ➡️</button>
      </div>
    </div>
  </div>
</div>

<script>
const results = [
  {% for file in result_images %}
    { url: "{{ file.url }}", note: "{{ file.note|default('') }}" }{{ "," if not loop.last }}
  {% endfor %}
];
let currentResultIndex = 0;

document.querySelectorAll('.result-thumb').forEach(img => {
  img.addEventListener('click', () => {
    currentResultIndex = parseInt(img.dataset.index);
    showResult();
    new bootstrap.Modal(document.getElementById('resultModal')).show();
  });
});

document.getElementById('prevResult').addEventListener('click', () => {
  currentResultIndex = (currentResultIndex - 1 + results.length) % results.length;
  showResult();
});

document.getElementById('nextResult').addEventListener('click', () => {
  currentResultIndex = (currentResultIndex + 1) % results.length;
  showResult();
});

function showResult() {
  const result = results[currentResultIndex];
  document.getElementById('modalResultImg').src = result.url;
  document.getElementById('modalResultNote').innerText = result.note;
}

function deleteFile(adm_no, public_id, type, btn) {
  if (!confirm("Are you sure you want to delete this file?")) return;
  fetch('/delete_file', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ adm_no, public_id, type })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      btn.closest('.col-md-4').remove();
    } else {
      alert("Error: " + data.error);
    }
  });
}
</script>
{% endblock %}
